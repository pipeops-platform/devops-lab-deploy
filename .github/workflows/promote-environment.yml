name: Promote Environment

on:
  workflow_dispatch:
    inputs:
      source_env:
        description: Source environment overlay (dev|staging)
        required: true
        type: choice
        options:
          - dev
          - staging
      target_env:
        description: Target environment overlay (staging|prod-blue|prod-green)
        required: true
        type: choice
        options:
          - staging
          - prod-blue
          - prod-green

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    name: Promote image between overlays
    runs-on: ubuntu-latest

    steps:
      - name: Validate promotion path
        env:
          SOURCE_ENV: ${{ inputs.source_env }}
          TARGET_ENV: ${{ inputs.target_env }}
        run: |
          if [ "$SOURCE_ENV" = "dev" ] && [ "$TARGET_ENV" = "staging" ]; then
            echo "Promotion path allowed: dev -> staging"
            exit 0
          fi

          if [ "$SOURCE_ENV" = "staging" ] && { [ "$TARGET_ENV" = "prod-blue" ] || [ "$TARGET_ENV" = "prod-green" ]; }; then
            echo "Promotion path allowed: staging -> $TARGET_ENV"
            exit 0
          fi

          echo "Invalid promotion path: $SOURCE_ENV -> $TARGET_ENV"
          exit 1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy image repo/tag from source to target
        id: promote
        env:
          SOURCE_ENV: ${{ inputs.source_env }}
          TARGET_ENV: ${{ inputs.target_env }}
        run: |
          python - <<'PY'
          from pathlib import Path
          import os
          import re

          source_env = "${{ env.SOURCE_ENV }}"
          target_env = "${{ env.TARGET_ENV }}"

          source_file = Path(f"apps/devops-lab-app/overlays/{source_env}/kustomization.yaml")
          target_file = Path(f"apps/devops-lab-app/overlays/{target_env}/kustomization.yaml")

          source_content = source_file.read_text(encoding="utf-8")
          target_content = target_file.read_text(encoding="utf-8")

          source_image_match = re.search(r'(?m)^\s*-\s*name:\s*(.+)$', source_content)
          source_tag_match = re.search(r'(?m)^\s*newTag:\s*"([^"]+)"\s*$', source_content)

          if not source_image_match or not source_tag_match:
            raise SystemExit("Could not read image name/newTag from source overlay")

          source_image = source_image_match.group(1).strip()
          source_tag = source_tag_match.group(1).strip()

          updated = re.sub(r'(?m)^(\s*-\s*name:\s*).+$', rf'\1{source_image}', target_content)
          updated = re.sub(r'(?m)^(\s*newTag:\s*").*("\s*)$', rf'\1{source_tag}\2', updated)

          target_file.write_text(updated, encoding="utf-8")

          github_output = Path(os.environ["GITHUB_OUTPUT"])
          with github_output.open("a", encoding="utf-8") as output:
            output.write(f"image_name={source_image}\n")
            output.write(f"image_tag={source_tag}\n")
          PY

      - name: Create promotion PR
        env:
          SOURCE_ENV: ${{ inputs.source_env }}
          TARGET_ENV: ${{ inputs.target_env }}
          IMAGE_NAME: ${{ steps.promote.outputs.image_name }}
          IMAGE_TAG: ${{ steps.promote.outputs.image_tag }}
        run: |
          TARGET_FILE="apps/devops-lab-app/overlays/${TARGET_ENV}/kustomization.yaml"

          if git diff --quiet -- "$TARGET_FILE"; then
            echo "No promotion change required"
            exit 0
          fi

          BRANCH="promote-${SOURCE_ENV}-to-${TARGET_ENV}-${IMAGE_TAG}"
          git checkout -B "$BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$TARGET_FILE"
          git commit -m "chore(deploy): promote ${TARGET_ENV} to ${IMAGE_TAG}"
          git push --force-with-lease --set-upstream origin "$BRANCH"

          EXISTING_PR=$(gh pr list --base main --head "$BRANCH" --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
            exit 0
          fi

          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "chore(deploy): promote ${SOURCE_ENV} -> ${TARGET_ENV} (${IMAGE_TAG})" \
            --body "Automated promotion in deploy repo.\n\n- Source environment: ${SOURCE_ENV}\n- Target environment: ${TARGET_ENV}\n- Image repository: ${IMAGE_NAME}\n- Image tag: ${IMAGE_TAG}"